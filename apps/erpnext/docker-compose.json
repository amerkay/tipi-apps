{
  "services": [
    {
      "name": "backend",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "on-failure",
      "environment": {
        "DB_HOST": "db",
        "DB_PORT": "3306",
        "MYSQL_ROOT_PASSWORD": "${DB_PASSWORD}",
        "MARIADB_ROOT_PASSWORD": "${DB_PASSWORD}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    },
    {
      "name": "configurator",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "no",
      "entrypoint": ["bash", "-c"],
      "command": "ls -1 apps > sites/apps.txt; bench set-config -g db_host $DB_HOST; bench set-config -gp db_port $DB_PORT; bench set-config -g redis_cache \"redis://$REDIS_CACHE\"; bench set-config -g redis_queue \"redis://$REDIS_QUEUE\"; bench set-config -g redis_socketio \"redis://$REDIS_QUEUE\"; bench set-config -gp socketio_port $SOCKETIO_PORT;",
      "environment": {
        "DB_HOST": "db",
        "DB_PORT": "3306",
        "REDIS_CACHE": "redis-cache:6379",
        "REDIS_QUEUE": "redis-queue:6379",
        "SOCKETIO_PORT": "9000"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    },
    {
      "name": "create-site",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "no",
      "entrypoint": ["bash", "-c"],
      "command": "wait-for-it -t 120 db:3306; wait-for-it -t 120 redis-cache:6379; wait-for-it -t 120 redis-queue:6379; export start=`date +%s`; until [[ -n `grep -hs ^ sites/common_site_config.json | jq -r \".db_host // empty\"` ]] && [[ -n `grep -hs ^ sites/common_site_config.json | jq -r \".redis_cache // empty\"` ]] && [[ -n `grep -hs ^ sites/common_site_config.json | jq -r \".redis_queue // empty\"` ]]; do echo \"Waiting for sites/common_site_config.json to be created\"; sleep 5; if (( `date +%s`-start > 120 )); then echo \"could not find sites/common_site_config.json with required keys\"; exit 1; fi; done; echo \"sites/common_site_config.json found\"; bench new-site --mariadb-user-host-login-scope='%' --admin-password=${ADMIN_PASSWORD} --db-root-username=root --db-root-password=${DB_PASSWORD} --install-app erpnext --set-default frontend",
      "environment": {
        "ADMIN_PASSWORD": "${ADMIN_PASSWORD}",
        "DB_PASSWORD": "${DB_PASSWORD}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    },
    {
      "name": "db",
      "image": "mariadb:10.6",
      "restart": "on-failure",
      "healthCheck": {
        "test": "mysqladmin ping -h localhost --password=${DB_PASSWORD}",
        "interval": "1s",
        "retries": 20
      },
      "command": [
        "--character-set-server=utf8mb4",
        "--collation-server=utf8mb4_unicode_ci",
        "--skip-character-set-client-handshake",
        "--skip-innodb-read-only-compressed"
      ],
      "environment": {
        "MYSQL_ROOT_PASSWORD": "${DB_PASSWORD}",
        "MARIADB_ROOT_PASSWORD": "${DB_PASSWORD}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/db",
          "containerPath": "/var/lib/mysql"
        }
      ]
    },
    {
      "name": "frontend",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "on-failure",
      "dependsOn": {
        "websocket": {
          "condition": "service_healthy"
        }
      },
      "command": ["nginx-entrypoint.sh"],
      "environment": {
        "BACKEND": "backend:8000",
        "FRAPPE_SITE_NAME_HEADER": "${FRAPPE_SITE_NAME_HEADER}",
        "SOCKETIO": "websocket:9000",
        "UPSTREAM_REAL_IP_ADDRESS": "${UPSTREAM_REAL_IP_ADDRESS}",
        "UPSTREAM_REAL_IP_HEADER": "${UPSTREAM_REAL_IP_HEADER}",
        "UPSTREAM_REAL_IP_RECURSIVE": "${UPSTREAM_REAL_IP_RECURSIVE}",
        "PROXY_READ_TIMEOUT": "${PROXY_READ_TIMEOUT}",
        "CLIENT_MAX_BODY_SIZE": "${CLIENT_MAX_BODY_SIZE}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ],
      "isMain": true,
      "internalPort": 8080
    },
    {
      "name": "queue-long",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "on-failure",
      "command": ["bench", "worker", "--queue", "long,default,short"],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    },
    {
      "name": "queue-short",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "on-failure",
      "command": ["bench", "worker", "--queue", "short,default"],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    },
    {
      "name": "redis-queue",
      "image": "redis:6.2-alpine",
      "restart": "on-failure",
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/redis-queue",
          "containerPath": "/data"
        }
      ]
    },
    {
      "name": "redis-cache",
      "image": "redis:6.2-alpine",
      "restart": "on-failure"
    },
    {
      "name": "scheduler",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "on-failure",
      "command": ["bench", "schedule"],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    },
    {
      "name": "websocket",
      "image": "frappe/erpnext:v15.69.2",
      "restart": "on-failure",
      "command": ["node", "/home/frappe/frappe-bench/apps/frappe/socketio.js"],
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/sites",
          "containerPath": "/home/frappe/frappe-bench/sites"
        },
        {
          "hostPath": "${APP_DATA_DIR}/logs",
          "containerPath": "/home/frappe/frappe-bench/logs"
        }
      ]
    }
  ],
  "$schema": "../dynamic-compose-schema.json"
}
